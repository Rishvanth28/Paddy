{% extends 'customer_base.html' %}
{% load static %}

{% block content %}
<style>
:root {
    --primary: #3b82f6;
    --primary-dark: #1e40af;
    --accent: #f59e42;
    --bg: #f4f8fb;
    --glass: rgba(255,255,255,0.98);
    --shadow: 0 4px 24px 0 rgba(59,130,246,0.08);
    --border: 1.5px solid #e5e7eb;
    --radius: 16px;
    --text-main: #1e293b;
    --text-secondary: #64748b;
    --success: #22c55e;
    --warning: #f59e42;
    --danger: #ef4444;
    --info: #38bdf8;
}
body { background: var(--bg); color: var(--text-main); }

.customer-dashboard-hero {
    background: linear-gradient(90deg, #3b82f6 0%, #38bdf8 100%);
    color: #fff;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    padding: 2.5rem 2rem 2rem 2rem;
    margin-bottom: 2.5rem;
    text-align: left;
    position: relative;
    overflow: hidden;
}
.customer-dashboard-hero h1 { font-size: 2.3rem; margin-bottom: 0.5rem; font-weight: 700; }
.customer-dashboard-hero p { font-size: 1.1rem; opacity: 0.95; max-width: 600px; margin-bottom: 1.5rem; }
.order-summary { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1rem; }
.order-summary-badge {
    background: rgba(255,255,255,0.25);
    border-radius: 50px;
    padding: 0.6rem 1.2rem;
    font-size: 1.05rem;
    font-weight: 700;
    color: #fff;
    box-shadow: 0 2px 8px 0 rgba(59,130,246,0.10);
}
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}
.stat-card {
    background: var(--glass);
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    border: var(--border);
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    transition: transform 0.2s, box-shadow 0.2s;
}
.stat-card:hover {
    transform: translateY(-4px) scale(1.02);
    box-shadow: 0 8px 32px 0 rgba(59,130,246,0.13);
}
.stat-title { font-size: 1.05rem; color: var(--text-secondary); margin-bottom: 0.5rem; font-weight: 600; }
.stat-value { font-size: 2.1rem; font-weight: 800; color: var(--primary-dark); margin-bottom: 0.25rem; }
.stat-info { font-size: 0.95rem; color: var(--text-secondary); }
.chart-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}
.chart-card {
    background: var(--glass);
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    border: var(--border);
    height: 100%;
}
.chart-title { font-size: 1.2rem; color: var(--primary-dark); margin-bottom: 1.2rem; font-weight: 700; }
.chart-container { position: relative; height: 260px; width: 100%; }
.table-section {
    background: var(--glass);
    border-radius: var(--radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
    border: var(--border);
    margin-bottom: 2rem;
}
.section-title { font-size: 1.15rem; color: var(--primary-dark); margin-bottom: 1.2rem; font-weight: 700; }
.recent-orders-table { width: 100%; border-collapse: separate; border-spacing: 0; }
.recent-orders-table th, .recent-orders-table td {
    padding: 1rem;
    text-align: left;
    border-bottom: 1px solid #e5e7eb;
}
.recent-orders-table th {
    font-weight: 700;
    color: var(--primary-dark);
    font-size: 0.95rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    background: #f1f5f9;
}
.recent-orders-table td { color: var(--text-main); font-size: 1.05rem; }
.recent-orders-table tr:last-child td { border-bottom: none; }
.status-badge {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 0.3rem 0.9rem;
    border-radius: 50px;
    font-size: 0.85rem;
    font-weight: 700;
    letter-spacing: 0.5px;
}
.status-pending { background: #fef3c7; color: #b45309; border: 1.5px solid #fde68a; }
.status-partial { background: #e0f2fe; color: #0369a1; border: 1.5px solid #7dd3fc; }
.status-completed { background: #dcfce7; color: #15803d; border: 1.5px solid #86efac; }
.table-responsive { overflow-x: auto; }
.btn-primary {
    background: linear-gradient(90deg, #3b82f6 0%, #38bdf8 100%);
    color: #fff;
    border: none;
    padding: 0.45rem 1.1rem;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 700;
    transition: background 0.2s;
}
.btn-primary:hover { background: linear-gradient(90deg, #2563eb 0%, #0ea5e9 100%); }
@media (max-width: 1024px) { .chart-grid { grid-template-columns: 1fr; } }
@media (max-width: 768px) {
    .stats-grid { grid-template-columns: 1fr 1fr; }
    .customer-dashboard-hero { padding: 2rem 1.2rem; }
    .customer-dashboard-hero h1 { font-size: 1.7rem; }
}
@media (max-width: 576px) {
    .stats-grid { grid-template-columns: 1fr; }
    .table-responsive { overflow-x: auto; }
    .customer-dashboard-hero h1 { font-size: 1.2rem; }
    .customer-dashboard-hero p { font-size: 0.98rem; }
    .stat-card .stat-value { font-size: 1.3rem; }
}
</style>
<div class="container-fluid">
    <div class="customer-dashboard-hero">
        <h1>Welcome, {{ customer.first_name }}!</h1>
        <p>Your orders, payments, and deliveries at a glance.</p>
        <div class="order-summary">
            <div class="order-summary-badge">Total Orders: {{ total_orders }}</div>
            <div class="order-summary-badge">Pending Deliveries: {{ pending_delivery }}</div>
            <div class="order-summary-badge">Pending Payments: {{ pending_payment }}</div>
        </div>
    </div>
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-title">Total Amount</div>
            <div class="stat-value">₹{{ total_amount|floatformat:2 }}</div>
            <div class="stat-info">All orders placed</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Amount Paid</div>
            <div class="stat-value">₹{{ paid_amount|floatformat:2 }}</div>
            <div class="stat-info">Payments completed</div>
        </div>
        <div class="stat-card">
            <div class="stat-title">Due Amount</div>
            <div class="stat-value">₹{{ due_amount|floatformat:2 }}</div>
            <div class="stat-info">Payments pending</div>
        </div>
    </div>
    <div class="chart-grid">
        <div class="chart-card">
            <div class="chart-title">Payment Status</div>
            <div class="chart-container">
                <canvas id="paymentStatusChart"></canvas>
            </div>
        </div>
        <div class="chart-card">
            <div class="chart-title">Order Categories</div>
            <div class="chart-container">
                <canvas id="categoryChart"></canvas>
            </div>
        </div>
    </div>
    <div class="table-section">
        <div class="section-title">Recent Orders</div>
        <div class="table-responsive">
            <table class="recent-orders-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Payment Status</th>
                        <th>Delivery Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in recent_orders %}
                    <tr>
                        <td>#{{ order.order_id }}</td>
                        <td>{{ order.order_date|date:"M d, Y" }}</td>
                        <td>₹{{ order.overall_amount|floatformat:2 }}</td>
                        <td>
                            {% if order.payment_status == 0 %}
                            <span class="status-badge status-pending">Pending</span>
                            {% elif order.payment_status == 1 %}
                            <span class="status-badge status-partial">Partial</span>
                            {% elif order.payment_status == 2 %}
                            <span class="status-badge status-completed">Completed</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.delivery_status == 0 %}
                            <span class="status-badge status-pending">Pending</span>
                            {% elif order.delivery_status == 1 %}
                            <span class="status-badge status-completed">Completed</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center;">No recent orders found</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="table-section">
        <div class="section-title">Pending Payments</div>
        <div class="table-responsive">
            <table class="recent-orders-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Date</th>
                        <th>Total Amount</th>
                        <th>Due Amount</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in due_payments %}
                    <tr>
                        <td>#{{ order.order_id }}</td>
                        <td>{{ order.order_date|date:"M d, Y" }}</td>
                        <td>₹{{ order.overall_amount|floatformat:2 }}</td>
                        <td><strong>₹{{ order.due_amount|default:"0.00"|floatformat:2 }}</strong></td>
                        <td>
                            <form action="{% url 'payment' %}" method="post">
                                {% csrf_token %}
                                <input type="hidden" name="order_id" value="{{ order.order_id }}">
                                <button type="submit" class="btn btn-primary btn-sm">Pay Now</button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center;">No pending payments</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="table-section">
        <div class="section-title">Upcoming Deliveries</div>
        <div class="table-responsive">
            <table class="recent-orders-table">
                <thead>
                    <tr>
                        <th>Order ID</th>
                        <th>Delivery Date</th>
                        <th>Category</th>
                        <th>Quantity</th>
                        <th>Contact</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in upcoming_deliveries %}
                    <tr>
                        <td>#{{ order.order_id }}</td>
                        <td>{{ order.delivery_date|date:"M d, Y" }}</td>
                        <td>{{ order.category }}</td>
                        <td>{{ order.quantity }}</td>
                        <td>{{ order.driver_ph_no|default:"Not available" }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" style="text-align: center;">No upcoming deliveries</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const categoryData = {{ category_data_json|safe }};
const paymentStatusData = {{ payment_status_json|safe }};
function pastelColors(count) {
    const palette = [
        '#3b82f6','#f59e42','#22c55e','#f472b6','#a78bfa','#facc15','#38bdf8','#f87171','#34d399','#fbbf24','#818cf8','#f43f5e'
    ];
    let colors = [];
    for (let i = 0; i < count; i++) {
        colors.push(palette[i % palette.length]);
    }
    return colors;
}
document.addEventListener('DOMContentLoaded', function() {
    // Category Pie Chart
    if (categoryData && categoryData.length > 0) {
        const ctx = document.getElementById('categoryChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: categoryData.map(item => item.name),
                datasets: [{
                    data: categoryData.map(item => item.count),
                    backgroundColor: pastelColors(categoryData.length),
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 13 }, color: '#1e293b' } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a,b) => a+b, 0);
                                const percent = Math.round((context.parsed * 100) / total);
                                return `${context.label}: ${context.parsed} (${percent}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
    // Payment Status Doughnut
    if (paymentStatusData && paymentStatusData.length > 0) {
        const ctx = document.getElementById('paymentStatusChart').getContext('2d');
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: paymentStatusData.map(item => item.name),
                datasets: [{
                    data: paymentStatusData.map(item => item.count),
                    backgroundColor: pastelColors(paymentStatusData.length),
                    borderColor: '#fff',
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                cutout: '65%',
                plugins: {
                    legend: { position: 'bottom', labels: { font: { size: 13 }, color: '#1e293b' } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a,b) => a+b, 0);
                                const percent = Math.round((context.parsed * 100) / total);
                                return `${context.label}: ${context.parsed} (${percent}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
